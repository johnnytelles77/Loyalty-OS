package com.loyalty.services;

import com.loyalty.dtos.*;
import com.loyalty.models.*;
import com.loyalty.repositories.*;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class BusinessDashboardService {

    @Autowired
    private BusinessService businessService;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private TransactionRepository transactionRepository;

    @Autowired
    private RewardConfigRepository rewardConfigRepository;

    public DashboardInfoDTO getDashboardInfo(String token) {

        Business business = businessService.getAuthenticatedBusinessEntity(token);

        if (business == null) {
            throw new IllegalArgumentException("Negocio no encontrado");
        }

        long totalUsers = userRepository.countByBusinessId(business.getId());

        Long totalPointsEarned =
                transactionRepository.sumPointsByType(business.getId(), "EARN");

        Long totalPointsRedeemed =
                transactionRepository.sumPointsByType(business.getId(), "REDEEM");

        List<Transaction> lastActivities =
                transactionRepository.findTop10ByBusinessIdOrderByCreatedAtDesc(business.getId());

        RewardConfig config =
                rewardConfigRepository.findByBusinessId(business.getId()).orElse(null);

        return DashboardInfoDTO.builder()
                .businessName(business.getName())
                .totalUsers(totalUsers)
                .totalPointsEarned(totalPointsEarned != null ? totalPointsEarned : 0)
                .totalPointsRedeemed(totalPointsRedeemed != null ? totalPointsRedeemed : 0)
                .recentActivities(
                        lastActivities.stream()
                                .map(RecentActivityDTO::fromTransaction)
                                .toList()
                )
                .rewardConfig(config != null ? RewardConfigDTO.from(config) : null)
                .build();
    }
}