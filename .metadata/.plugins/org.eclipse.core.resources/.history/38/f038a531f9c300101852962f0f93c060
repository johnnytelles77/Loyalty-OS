package com.loyalty.services;

import com.loyalty.dtos.*;
import com.loyalty.models.*;
import com.loyalty.repositories.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.util.List;

@Service
public class BusinessDashboardService {

    @Autowired
    private BusinessService businessService;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private LoyaltyLogRepository loyaltyLogRepository;

    @Autowired
    private RewardConfigRepository rewardConfigRepository;

    public DashboardInfoDTO getDashboardInfo(String token) {

        Business business = businessService.getAuthenticatedBusinessEntity(token);
        if (business == null) throw new IllegalArgumentException("Negocio no encontrado");

        long totalUsers = userRepository.countByNegocioId(business.getId());

        List<LoyaltyLog> logs = loyaltyLogRepository.findTop10ByUser_Negocio_IdOrderByFechaDesc(business.getId());

        int totalPointsEarned = loyaltyLogRepository.sumPointsByType(logs, "ASIGNACION");
        int totalPointsRedeemed = loyaltyLogRepository.sumPointsByType(logs, "CANJE");

        RewardConfig config = rewardConfigRepository.findByNegocioId(business.getId()).orElse(null);

        return DashboardInfoDTO.builder()
                .businessName(business.getNombre())
                .totalUsers(totalUsers)
                .totalPointsEarned(totalPointsEarned)
                .totalPointsRedeemed(totalPointsRedeemed)
                .recentActivities(
                        logs.stream().map(RecentActivityDTO::fromLoyaltyLog).toList()
                )
                .rewardConfig(config != null ? RewardConfigDTO.from(config) : null)
                .build();
    }
}